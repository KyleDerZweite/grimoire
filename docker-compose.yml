services:
  # The Build Engine - pulls & rebuilds sites on a schedule
  builder:
    build:
      context: .
      dockerfile: Dockerfile.builder
    container_name: grimoire_builder
    restart: unless-stopped
    volumes:
      - .:/app
    environment:
      - BUILD_INTERVAL=${BUILD_INTERVAL:-7200}
      - GIT_BRANCH=${GIT_BRANCH:-main}
      - BUILD_ON_START=${BUILD_ON_START:-true}

  # The Traffic Director - serves all static sites
  router:
    image: nginx:alpine
    container_name: grimoire_router
    restart: unless-stopped
    volumes:
      # Mount built sites into NGINX html directory
      # Add new sites here: ./sites/<name>/dist:/usr/share/nginx/html/<name>
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./sites/sircookie/dist:/usr/share/nginx/html/sircookie:ro
      - ./sites/yunasoul/dist:/usr/share/nginx/html/yunasoul:ro
    networks:
      - pangolin_net
    depends_on:
      builder:
        condition: service_started

  # The Network Connector - tunnels traffic from Pangolin
  newt:
    image: fosrl/newt:latest
    container_name: grimoire_newt
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - PANGOLIN_ENDPOINT=${PANGOLIN_ENDPOINT}
      - NEWT_ID=${NEWT_ID}
      - NEWT_SECRET=${NEWT_SECRET}
    networks:
      - pangolin_net
    depends_on:
      - router

networks:
  pangolin_net:
    external: true
